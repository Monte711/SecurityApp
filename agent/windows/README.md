# UECP Agent Windows

Агент безопасности для Windows, выполняющий инвентаризацию системы и базовую оценку безопасности.

## Возможности

- **Инвентаризация системы**: Сбор информации о хосте, процессах, автозапусках
- **Оценка безопасности**: Проверка состояния Windows Defender, Firewall, UAC, RDP, BitLocker, SMB1
- **Рекомендации**: Автоматическая генерация рекомендаций по улучшению безопасности
- **Отправка данных**: Интеграция с API для передачи собранных данных
- **Offline режим**: Сохранение данных в спул при недоступности API
- **Цифровые подписи**: Проверка подписей исполняемых файлов
- **Хеширование**: Вычисление SHA256 хешей файлов (опционально)

## Требования

- Windows 10/11 или Windows Server 2016+
- Права администратора (рекомендуется для полной функциональности)
- Go 1.22+ (для сборки)

## Установка

### Сборка из исходного кода

```bash
# Клонирование репозитория
git clone <repository-url>
cd agent/windows

# Сборка
go build -o uecp-agent.exe cmd/uecp-agent/main.go

# Создание директорий
mkdir C:\ProgramData\UECP\spool
mkdir C:\ProgramData\UECP\logs
```

### Настройка конфигурации

Создайте файл `config.json`:

```json
{
  "ingest_url": "http://localhost:8000/ingest",
  "agent_id": "win-agent-001",
  "agent_version": "0.1.0",
  "collect_hashes": false,
  "run_mode": "daemon",
  "interval_seconds": 3600,
  "spool_dir": "C:\\ProgramData\\UECP\\spool",
  "log_file": "C:\\ProgramData\\UECP\\logs\\agent.log",
  "log_level": "info",
  "timeout_seconds": 30
}
```

## Использование

### Однократный запуск

```powershell
# Запуск с сохранением в файл
.\uecp-agent.exe -config config.json -once -output result.json

# Запуск с отправкой в API
.\uecp-agent.exe -config config.json -once
```

### Режим демона

```powershell
# Запуск в режиме демона
.\uecp-agent.exe -config config.json
```

### Установка как службы Windows

```powershell
# Создание службы
sc create "UECP Agent" binPath= "C:\path\to\uecp-agent.exe -config C:\path\to\config.json"

# Запуск службы
sc start "UECP Agent"
```

## Структура данных

Агент собирает следующие данные:

### Информация о хосте
- ID хоста (MachineGuid из реестра)
- Имя хоста
- Версия ОС
- Время работы системы
- Временная зона

### Инвентаризация
- **Процессы**: Список запущенных процессов с подписями и хешами
- **Автозапуски**: 
  - Записи реестра (Run, RunOnce)
  - Папки автозапуска
  - Автоматические службы
  - Запланированные задачи

### Параметры безопасности
- Windows Defender (статус, настройки)
- Windows Firewall (профили, правила)
- UAC (User Account Control)
- RDP (Remote Desktop Protocol)
- BitLocker (шифрование дисков)
- SMB1 (статус протокола)

### Рекомендации по безопасности
- Отключенный Firewall
- Выключенная защита Defender в реальном времени
- Отключенный UAC
- Небезопасная конфигурация RDP
- Неподписанные автозапуски
- Несуществующие файлы автозапуска
- Процессы в временных папках
- Включенный SMB1
- Выключенный BitLocker

## API интеграция

Агент отправляет данные в формате JSON через HTTP POST запрос:

```http
POST /ingest
Content-Type: application/json

{
  "event_type": "host_posture",
  "timestamp": "2024-01-01T12:00:00Z",
  "agent": {
    "agent_id": "win-agent-001",
    "agent_version": "0.1.0",
    "hostname": "DESKTOP-ABC123"
  },
  "host": {
    "host_id": "12345678-1234-1234-1234-123456789012",
    "hostname": "DESKTOP-ABC123",
    "os_version": "Windows 11 Pro",
    "uptime_seconds": 3600,
    "timezone": "UTC+03:00"
  },
  "inventory": {
    "processes": [...],
    "autoruns": {...}
  },
  "security": {
    "defender": {...},
    "firewall": {...},
    "uac": {...},
    "rdp": {...},
    "bitlocker": {...},
    "smb1": {...}
  },
  "findings": [...]
}
```

## Конфигурация

### Параметры конфигурации

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `ingest_url` | URL API для отправки данных | `http://localhost:8000/ingest` |
| `agent_id` | Уникальный ID агента | `win-agent-001` |
| `agent_version` | Версия агента | `0.1.0` |
| `collect_hashes` | Вычислять SHA256 хеши файлов | `false` |
| `run_mode` | Режим запуска: `once` или `daemon` | `once` |
| `interval_seconds` | Интервал сбора в секундах (режим daemon) | `3600` |
| `spool_dir` | Директория для локального хранения | `C:\ProgramData\UECP\spool` |
| `log_file` | Файл лога | `C:\ProgramData\UECP\logs\agent.log` |
| `log_level` | Уровень логирования | `info` |
| `timeout_seconds` | Таймаут операций в секундах | `30` |

### Примеры конфигураций

#### Минимальная конфигурация
```json
{
  "ingest_url": "https://your-api.com/ingest",
  "agent_id": "unique-agent-id"
}
```

#### Конфигурация для тестирования
```json
{
  "ingest_url": "",
  "run_mode": "once",
  "collect_hashes": true,
  "spool_dir": "./test-spool"
}
```

## Логирование

Агент ведет подробные логи всех операций:

```
2024-01-01 12:00:00 Запуск UECP Agent Windows v0.1.0
2024-01-01 12:00:01 Начинается сбор данных о состоянии хоста...
2024-01-01 12:00:15 Собрано данных: процессов=156, автозапусков=42
2024-01-01 12:00:16 Создано рекомендаций: 3
2024-01-01 12:00:17 Данные успешно отправлены в API
```

## Безопасность

### Права доступа
- Для полной функциональности требуются права администратора
- При отсутствии прав возвращается ошибка "permission denied"
- Агент корректно обрабатывает ограниченные права

### Хранение данных
- Локальные файлы спула создаются с правами доступа 0600
- Логи создаются с правами доступа 0644
- Конфигурация может содержать чувствительные данные

### Сетевая безопасность
- Поддержка HTTPS для API
- Настраиваемые таймауты
- Retry логика для надежности

## Устранение неисправностей

### Агент не запускается
1. Проверьте наличие прав администратора
2. Убедитесь в корректности файла конфигурации
3. Проверьте доступность директорий спула и логов

### Данные не отправляются в API
1. Проверьте доступность URL API
2. Убедитесь в корректности формата данных
3. Проверьте логи агента для деталей ошибок

### Отсутствуют некоторые данные
1. Недостаточно прав доступа - запустите от имени администратора
2. Отключенные службы Windows (Defender, Firewall)
3. Устаревшая версия Windows

## Разработка

### Архитектура

```
cmd/uecp-agent/     # Главная программа
internal/
├── collect/        # Модули сбора данных
├── recommend/      # Движок рекомендаций
├── transport/      # Отправка данных
├── store/          # Локальное хранение
└── util/           # Утилиты (PowerShell, хеши, подписи)
```

### Добавление новых проверок безопасности

1. Добавьте сбор параметра в `internal/collect/security.go`
2. Создайте правило в `internal/recommend/engine.go`
3. Обновите структуру данных в соответствующих файлах

### Тестирование

```bash
# Запуск тестов
go test ./...

# Тестирование сборки
go build cmd/uecp-agent/main.go

# Тестовый запуск
./main.exe -config config.json -once -output test.json
```

## Лицензия

Внутренний проект UECP. Все права защищены.
